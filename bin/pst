#!/bin/bash

linux_detect_ascii () {
    ascii=
    pstree --help 2>&1 | grep -q -- '-A .*ASCII' && ascii=-A
}

linux_pstree () {
    LANG=C pstree $ascii -p "$@"
}

get_pgid() {
    ps -o pgid= -p "$1" 2>/dev/null | tr -d ' '
}

linux_iterate () {
    opts=( )
    while [ -n "$1" ]; do
        case "$1" in
            -*)
                opts=( "${opts[@]}" "$1" )
                shift
                ;;
            *)
                break
                ;;
        esac
    done

    if [ $# = 0 ]; then
        linux_pstree "${opts[@]}"
    elif [ -d "/proc/$1" ]; then
        linux_pstree "${opts[@]}" "$@"
    else
        current_pgid=$(get_pgid $$)
        for proc in "$@"; do
            echo "Searching for processes containing '$proc' ..."
            matching_pids=(`pgrep -f "$proc"`)

            for pid in "${matching_pids[@]}"; do
                # Skip processes in the current process group (including this script)
                pid_pgid=$(get_pgid "$pid")
                if [ -z "$pid_pgid" ] || [ "$pid_pgid" = "$current_pgid" ]; then
                    continue
                fi

                # Check if this process has a parent that also matches our search
                ppid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
                has_matching_parent=false
                for other_pid in "${matching_pids[@]}"; do
                    if [ "$other_pid" = "$ppid" ]; then
                        has_matching_parent=true
                        break
                    fi
                done

                # Only show trees for root processes (no matching parent)
                if [ "$has_matching_parent" = "false" ]; then
                    linux_pstree "${opts[@]}" "$pid"
                fi
            done
        done
    fi
}

case "$OSTYPE" in
    solaris*)
        exec ptree "$@" | less -rS
        ;;
    *)
        if ! which pstree 2>&1 >/dev/null; then
            echo "pstree not found."
            exit 1
        fi

        linux_detect_ascii

        linux_iterate "$@" | less -rSFX
        ;;
esac
